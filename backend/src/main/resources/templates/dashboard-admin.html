<!DOCTYPE html>
<html th:replace="~{layout :: layout(~{::main})}" xmlns:th="http://www.thymeleaf.org">

<body>
    <main>
        <section style="padding: 100px 0;">
            <div class="container">
                <div style="margin-bottom: 4rem;">
                    <span
                        style="color: var(--primary); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem;">Sistem
                        YÃ¶neticisi Paneli</span>
                    <h1 style="font-size: 3.5rem; font-weight: 800; margin-top: 1rem;">Global YÃ¶netim</h1>
                </div>
                <div style="margin-top: 2rem; display:flex; gap:1.5rem;">
                    <div class="feature-card" style="flex:1;">
                        <h3>Ãœniversite Sorumlusu Ekle (Manuel)</h3>
                        <div style="margin-top: 1rem; display:flex; gap:0.5rem; align-items:center;">
                            <select id="adminUniSelect" style="padding:8px;">
                                <option th:each="u : ${universities}" th:value="${u.id}" th:text="${u.name}"></option>
                            </select>
                            <button class="btn" style="margin-left:8px;" onclick="assignAllEventsToSelected()">Bu
                                Ã¼niversiteye Ã–nceki Etkinlikleri Ata</button>
                            <input id="adminSearch" placeholder="Ara (isim veya e-posta)"
                                style="flex:1; padding:8px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;" />
                            <button class="btn btn-primary" onclick="searchUsers()">Ara</button>
                            <button class="btn" style="margin-left:8px;" onclick="openManualAdd()">Manuel Ekle</button>
                        </div>
                        <div id="adminResults" style="margin-top:1rem; max-height:300px; overflow:auto;"></div>

                    </div>
                    <!-- Manual Add Modal -->
                    <div id="manualAddModal"
                        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
                        <div style="width:900px; max-width:95%; background:var(--bg); padding:18px; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>Ã–ÄŸrenci / OrganizatÃ¶r Listesi</h3>
                                <button class="btn" onclick="closeManualAdd()">Kapat</button>
                            </div>
                            <div style="margin-top:8px; display:flex; gap:8px;">
                                <input id="modalSearch" placeholder="Ara isim veya e-posta"
                                    style="flex:1; padding:8px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;" />
                                <button class="btn btn-primary" onclick="modalSearch()">Ara</button>
                            </div>
                            <div id="modalList"
                                style="margin-top:12px; max-height:400px; overflow:auto; border-top:1px solid var(--glass-border);">
                            </div>
                            <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                                <button class="btn btn-primary" onclick="openCreateAssign()">Yeni OluÅŸtur ve
                                    Atama</button>
                            </div>
                        </div>
                    </div>
                    <!-- Create & Assign Modal -->
                    <div id="createAssignModal"
                        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
                        <div style="width:420px; max-width:95%; background:var(--bg); padding:18px; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>Yeni Ãœniversite Sorumlusu OluÅŸtur</h3><button class="btn"
                                    onclick="closeCreateAssign()">Kapat</button>
                            </div>
                            <div style="margin-top:8px;">
                                <input id="caFullName" placeholder="Ä°sim Soyisim"
                                    style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;" />
                                <input id="caEmail" placeholder="e-posta"
                                    style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;" />
                                <input id="caPassword" placeholder="Åžifre" type="password"
                                    style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;" />
                                <div style="margin-top:6px;">
                                    <label style="font-size:0.9rem;color:var(--text-muted)">Ãœniversite</label>
                                    <select id="caUniversitySelect"
                                        style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white;">
                                        <option th:each="u : ${universities}" th:value="${u.id}" th:text="${u.name}">
                                        </option>
                                    </select>
                                </div>
                                <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;"><button
                                        class="btn btn-primary" onclick="createAndAssign()">OluÅŸtur ve Ata</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        // Open modal which lists all students/organizers
                        function openManualAdd() {
                            document.getElementById('manualAddModal').style.display = 'flex';
                            // load initial list (no query)
                            loadModalList('');
                        }
                        function closeManualAdd() { document.getElementById('manualAddModal').style.display = 'none'; }
                        function openCreateAssign() { document.getElementById('createAssignModal').style.display = 'flex'; }
                        function closeCreateAssign() { document.getElementById('createAssignModal').style.display = 'none'; }

                        async function searchUsers() {
                            const q = document.getElementById('adminSearch').value;
                            await loadAdminResults(q);
                        }

                        async function loadAdminResults(q) {
                            const res = await fetch('/api/admin/search-users' + (q ? ('?q=' + encodeURIComponent(q)) : ''), { credentials: 'same-origin' });
                            if (!res.ok) { alert('Arama hatasÄ±'); return; }
                            const data = await res.json();
                            const list = data.data || [];
                            const container = document.getElementById('adminResults');
                            container.innerHTML = '';
                            if (list.length === 0) {
                                container.innerHTML = '<div style="color:var(--text-muted)">EÅŸleÅŸen kullanÄ±cÄ± yok.</div>';
                                return;
                            }
                            for (const u of list) {
                                const div = document.createElement('div');
                                div.style.padding = '8px';
                                div.style.borderBottom = '1px solid var(--glass-border)';
                                div.innerHTML = `<strong>${u.fullName}</strong> <span style="color:var(--text-muted)">${u.email}</span> <button style="float:right;" class="btn btn-primary" onclick="promoteUser('${u.email}')">Atama Yap</button>`;
                                container.appendChild(div);
                            }
                            // show register option
                            const reg = document.getElementById('adminRegister');
                            reg.style.display = 'block';
                            document.getElementById('regEmail').value = q || '';
                        }

                        async function promoteUser(email) {
                            const uniId = document.getElementById('adminUniSelect').value;
                            const res = await fetch(`/api/admin/add-staff?email=${encodeURIComponent(email)}&universityId=${encodeURIComponent(uniId)}`, { method: 'POST', credentials: 'same-origin' });
                            let json = {};
                            try { json = await res.json(); } catch (e) { }
                            if (res.ok) { alert('Atama gerÃ§ekleÅŸtirildi.'); await loadAdminResults(document.getElementById('adminSearch').value); await loadModalList(document.getElementById('modalSearch').value || ''); } else { alert('Hata: ' + (json.message || '')); }
                        }

                        function hideRegister() { document.getElementById('adminRegister').style.display = 'none'; }

                        // load modal list (used by modal and initial open)
                        async function loadModalList(q) {
                            const res = await fetch('/api/admin/search-users' + (q ? ('?q=' + encodeURIComponent(q)) : ''), { credentials: 'same-origin' });
                            if (!res.ok) { document.getElementById('modalList').innerHTML = '<div style="color:var(--text-muted)">YÃ¼klenemedi.</div>'; return; }
                            const data = await res.json();
                            const list = data.data || [];
                            const container = document.getElementById('modalList');
                            container.innerHTML = '';
                            if (list.length === 0) { container.innerHTML = '<div style="color:var(--text-muted)">KayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.</div>'; return; }
                            for (const u of list) {
                                const row = document.createElement('div');
                                row.style.display = 'flex';
                                row.style.alignItems = 'center';
                                row.style.padding = '8px';
                                row.style.borderBottom = '1px solid var(--glass-border)';
                                const left = document.createElement('div');
                                left.style.flex = '1';
                                left.innerHTML = `<strong>${u.fullName}</strong> <div style="color:var(--text-muted)">${u.email} â€¢ ${u.role}</div>`;
                                const btns = document.createElement('div');
                                const assignBtn = document.createElement('button');
                                assignBtn.className = 'btn btn-primary';
                                assignBtn.textContent = 'Ãœniversite Sorumlusu Yap';
                                assignBtn.onclick = () => promoteUser(u.email);
                                btns.appendChild(assignBtn);
                                row.appendChild(left);
                                row.appendChild(btns);
                                container.appendChild(row);
                            }
                        }

                        async function modalSearch() { const q = document.getElementById('modalSearch').value; await loadModalList(q); }

                        // Create & Assign: calls admin endpoint which expects form params
                        async function createAndAssign() {
                            const fullName = document.getElementById('caFullName').value;
                            const email = document.getElementById('caEmail').value;
                            const password = document.getElementById('caPassword').value;
                            const universityId = document.getElementById('caUniversitySelect') ? document.getElementById('caUniversitySelect').value : document.getElementById('adminUniSelect').value;
                            if (!fullName || !email || !password) { alert('TÃ¼m alanlarÄ± doldurun'); return; }
                            const form = new URLSearchParams();
                            form.append('fullName', fullName);
                            form.append('email', email);
                            form.append('password', password);
                            form.append('universityId', universityId);
                            const res = await fetch('/api/admin/create-and-assign', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString(), credentials: 'same-origin' });
                            let j = {};
                            try { j = await res.json(); } catch (e) { }
                            if (res.ok) { alert('KullanÄ±cÄ± oluÅŸturuldu ve atandÄ±.'); closeCreateAssign(); closeManualAdd(); await loadAdminResults(document.getElementById('adminSearch').value); } else { alert('Hata: ' + (j.message || '')); }
                        }

                        async function assignAllEventsToSelected() {
                            const uniId = document.getElementById('adminUniSelect').value;
                            if (!uniId) { alert('LÃ¼tfen bir Ã¼niversite seÃ§in'); return; }
                            if (!confirm('TÃ¼m etkinlikleri seÃ§ili Ã¼niversiteye atamak istediÄŸinizden emin misiniz?')) return;
                            const form = new URLSearchParams();
                            form.append('universityId', uniId);
                            const res = await fetch('/api/admin/assign-events', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString(), credentials: 'same-origin' });
                            let j = {};
                            try { j = await res.json(); } catch (e) { }
                            if (res.ok) { alert('Ä°ÅŸlem tamam: ' + (j.data || '')); } else { alert('Hata: ' + (j.message || '')); }
                        }

                        async function sendBroadcastNotification() {
                            const title = document.getElementById('bnTitle').value;
                            const message = document.getElementById('bnMessage').value;
                            if (!title || !message) { alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun'); return; }
                            const form = new URLSearchParams();
                            form.append('title', title);
                            form.append('message', message);
                            const res = await fetch('/api/admin/broadcast-notification', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString(), credentials: 'same-origin' });
                            let j = {};
                            try { j = await res.json(); } catch (e) { }
                            if (res.ok) { alert('Bildirim tÃ¼m kullanÄ±cÄ±lara gÃ¶nderildi.'); closeBNModal(); } else { alert('Hata: ' + (j.message || '')); }
                        }
                        function openBNModal() { document.getElementById('bnModal').style.display = 'flex'; }
                        function closeBNModal() { document.getElementById('bnModal').style.display = 'none'; }
                    </script>
                </div>

                <div class="feature-grid" style="margin-top: 0; grid-template-columns: 1fr 1fr;">
                    <div class="feature-card">
                        <h3>Ãœniversite SorumlularÄ±</h3>
                        <div th:each="uni : ${universities}"
                            style="margin-top: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border);">
                            <span th:text="${uni.name}">Ãœniversite</span>
                            <span style="color: var(--primary); font-size: 0.8rem; float: right;">1 Sorumlu</span>
                        </div>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ðŸ“Š</div>
                        <h3>Sistem AnalitiÄŸi</h3>
                        <div style="display: flex; gap: 2rem; margin-top: 1.5rem;">
                            <div>
                                <strong style="font-size: 2rem; display: block;" th:text="${totalUsers}">0</strong>
                                <span style="color: var(--text-muted); font-size: 0.8rem;">KayÄ±tlÄ± KullanÄ±cÄ±</span>
                            </div>
                            <div>
                                <strong style="font-size: 2rem; display: block;" th:text="${totalEvents}">0</strong>
                                <span style="color: var(--text-muted); font-size: 0.8rem;">Etkinlik</span>
                            </div>
                        </div>
                        <a th:href="@{/admin/users}" class="btn btn-primary"
                            style="margin-top: 2rem; display: inline-block;">TÃ¼m
                            KullanÄ±cÄ±larÄ±
                            GÃ¶r</a>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ðŸ“¢</div>
                        <h3>Genel Duyuru</h3>
                        <p style="color:var(--text-muted); font-size: 0.9rem; margin-top: 1rem;">TÃ¼m kayÄ±tlÄ±
                            kullanÄ±cÄ±lara anlÄ±k mobil bildirim gÃ¶nderin.</p>
                        <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="openBNModal()">Bildirim
                            GÃ¶nder</button>
                    </div>
                </div>
            </div>
            <!-- Broadcast Notification Modal -->
            <div id="bnModal"
                style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index: 1000;">
                <div
                    style="width:420px; max-width:95%; background:var(--bg); padding:18px; border-radius:8px; border: 1px solid var(--glass-border);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Toplu Bildirim GÃ¶nder</h3>
                        <button class="btn" onclick="closeBNModal()">Kapat</button>
                    </div>
                    <div style="margin-top:16px;">
                        <label style="font-size:0.9rem;color:var(--text-muted)">Bildirim BaÅŸlÄ±ÄŸÄ±</label>
                        <input id="bnTitle" placeholder="BaÅŸlÄ±k"
                            style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white; border-radius:4px;" />
                        <div style="margin-top:12px;">
                            <label style="font-size:0.9rem;color:var(--text-muted)">Bildirim MesajÄ±</label>
                            <textarea id="bnMessage" placeholder="Mesaj iÃ§eriÄŸi..." rows="4"
                                style="width:100%; padding:8px; margin-top:6px; background:var(--dark-muted); border:1px solid var(--glass-border); color:white; border-radius:4px; font-family:inherit;"></textarea>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end;">
                            <button class="btn btn-primary" onclick="sendBroadcastNotification()">YayÄ±nla</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</body>

</html>