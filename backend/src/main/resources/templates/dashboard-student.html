<!DOCTYPE html>
<html th:replace="~{layout :: layout(~{::main})}" xmlns:th="http://www.thymeleaf.org">

<body>
    <main>
        <section style="padding: 100px 0;">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4rem;">
                    <div>
                        <span
                            style="color: var(--primary); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem;">Ã–ÄŸrenci
                            Paneli</span>
                        <h1 style="font-size: 3.5rem; font-weight: 800; margin-top: 1rem;"
                            th:text="${'Merhaba, ' + user.fullName}">Merhaba, Ã–ÄŸrenci</h1>
                    </div>
                    <div id="promotionSection">
                        <button onclick="requestPromotion()" class="btn"
                            style="background: var(--glass-heavy); border: 1px solid var(--glass-border); color: white;">OrganizatÃ¶r
                            Olmak Ä°ste</button>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <div class="feature-card">
                        <h3>Bildirimler</h3>
                        <div th:if="${notifications == null or #lists.isEmpty(notifications)}"
                            style="color: var(--text-muted); margin-top: 0.5rem;">Yeni bildiriminiz yok.</div>
                        <ul th:if="${notifications != null and not #lists.isEmpty(notifications)}"
                            style="list-style: none; padding: 0; margin-top: 1rem;">
                            <li th:each="n : ${notifications}"
                                style="padding: 10px; border-bottom: 1px solid var(--glass-border);">
                                <strong th:text="${n.title}" style="display:block; color:white;"></strong>
                                <div th:text="${n.message}"
                                    style="font-size:0.9rem; color:var(--text-muted); white-space:pre-wrap;"></div>
                                <div style="font-size:0.75rem; color:var(--text-muted); margin-top:6px;"
                                    th:text="${#temporals.format(n.createdAt, 'yyyy-MM-dd HH:mm')}"></div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="feature-grid" style="margin-top: 0;">
                    <!-- katÄ±ldÄ±ÄŸÄ±m Etkinlikler -->
                    <div class="feature-card">
                        <div class="feature-icon">ðŸ“…</div>
                        <h3>KatÄ±ldÄ±ÄŸÄ±m Etkinlikler</h3>
                        <div th:if="${attendanceCheck == null or #lists.isEmpty(attendanceCheck.items)}">
                            <p style="color: var(--text-muted); margin-top: 1rem;">HenÃ¼z bir etkinliÄŸe katÄ±lmadÄ±nÄ±z.</p>
                        </div>
                        <ul th:if="${attendanceCheck != null and not #lists.isEmpty(attendanceCheck.items)}"
                            style="list-style: none; padding: 0; margin-top: 1rem;">
                            <th:block th:each="item : ${attendanceCheck.items}">
                                <li th:if="${item != null}"
                                    style="padding: 10px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong th:text="${item.eventTitle}"
                                            style="display: block; color:white;">Etkinlik
                                            AdÄ±</strong>
                                        <span th:text="${item.eventType}"
                                            style="font-size: 0.8rem; color: var(--text-muted);">TÃœR</span>
                                    </div>
                                    <span th:text="${item.verified ? 'âœ… OnaylandÄ±' : 'â³ Bekliyor'}"
                                        style="font-size: 0.9rem;">Durum</span>
                                </li>
                            </th:block>
                        </ul>
                    </div>

                    <!-- YaklaÅŸan Etkinlikler -->
                    <div class="feature-card">
                        <div class="feature-icon">ðŸš€</div>
                        <h3>YaklaÅŸan Etkinlikler</h3>
                        <div th:if="${events == null or #lists.isEmpty(events)}">
                            <p style="color: var(--text-muted); margin-top: 1rem;">YakÄ±n zamanda etkinlik bulunmuyor.
                            </p>
                        </div>
                        <ul th:if="${events != null and not #lists.isEmpty(events)}"
                            style="list-style: none; padding: 0; margin-top: 1rem;">
                            <th:block th:each="event : ${events}">
                                <li th:if="${event != null}"
                                    style="padding: 10px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong th:text="${event.title}"
                                            style="display: block; color:white;">Etkinlik</strong>
                                        <span th:text="${event.eventDate}"
                                            style="font-size: 0.8rem; color: var(--text-muted);">Tarih</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <span th:if="${event.price == null or event.price == 0}"
                                            style="color: var(--success); font-weight: 700; font-size: 0.9rem;">ÃœCRETSÄ°Z</span>
                                        <span th:if="${event.price != null and event.price > 0}"
                                            style="color: var(--primary); font-weight: 700; font-size: 0.9rem;"
                                            th:text="${'â‚º' + #numbers.formatDecimal(event.price, 1, 2)}">â‚º50.00</span>
                                        <div style="font-size: 0.75rem; margin-top: 4px;">
                                            <a th:href="@{'/events/' + ${event.id}}"
                                                style="color: var(--text-muted);">Detay â†’</a>
                                        </div>
                                    </div>
                                </li>
                            </th:block>
                        </ul>
                    </div>

                    <div class="feature-card">
                        <div class="feature-icon">ðŸŽ¨</div>
                        <h3>Ä°lgi AlanlarÄ±m</h3>
                        <p th:if="${user != null}" style="color: var(--text-muted); margin-top: 1rem;"
                            th:text="${#lists.isEmpty(user.interests) ? 'Ä°lgi alanÄ± eklenmemiÅŸ.' : #strings.listJoin(user.interests, ', ')}">
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <script>
            async function requestPromotion() {
                // Rely on HttpOnly cookie
                try {
                    const response = await fetch('/api/promotion/request', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (response.ok) {
                        alert('Ä°steÄŸiniz Ã¼niversite sorumlusuna iletildi.');
                        location.reload();
                    } else {
                        const err = await response.text();
                        alert('Hata: ' + err);
                    }
                } catch (e) {
                    alert('Bir hata oluÅŸtu.');
                }
            }
        </script>
    </main>
</body>

</html>